<template>
  <div class="markdown-editor-toolbar">
    <!-- Â∑¶‰æßÂØºËà™ -->
    <div class="toolbar-left">
      <el-button @click.stop="$emit('back')" @mousedown.prevent type="primary" plain size="small" tabindex="-1">
        <el-icon><ArrowLeft /></el-icon>
        ËøîÂõû
      </el-button>
      <span class="editor-title">Markdown Ê≤âÊµ∏ÂºèÁºñËæëÂô®</span>
    </div>

    <!-- ‰∏≠Èó¥Â∑•ÂÖ∑Ê†è -->
    <div class="toolbar-center">
      <!-- ÊñáÊú¨Ê†ºÂºèÂåñ -->
      <el-button-group size="small">
        <el-tooltip content="Á≤ó‰Ωì" placement="bottom">
          <el-button @click.stop="$emit('insert-format', 'bold')" @mousedown.prevent type="default" tabindex="-1">
            <strong>B</strong>
          </el-button>
        </el-tooltip>
        <el-tooltip content="Êñú‰Ωì" placement="bottom">
          <el-button @click.stop="$emit('insert-format', 'italic')" @mousedown.prevent type="default" tabindex="-1">
            <em>I</em>
          </el-button>
        </el-tooltip>
        <el-tooltip content="Âà†Èô§Á∫ø" placement="bottom">
          <el-button @click.stop="$emit('insert-format', 'strikethrough')" @mousedown.prevent type="default" tabindex="-1">
            <del>S</del>
          </el-button>
        </el-tooltip>
      </el-button-group>

      <el-divider direction="vertical" />

      <!-- Ê†áÈ¢òÂ±ÇÁ∫ß -->
      <el-button-group size="small">
        <el-tooltip content="‰∏ÄÁ∫ßÊ†áÈ¢ò" placement="bottom">
          <el-button @click.stop="$emit('insert-format', 'h1')" @mousedown.prevent type="default" tabindex="-1">H1</el-button>
        </el-tooltip>
        <el-tooltip content="‰∫åÁ∫ßÊ†áÈ¢ò" placement="bottom">
          <el-button @click.stop="$emit('insert-format', 'h2')" @mousedown.prevent type="default" tabindex="-1">H2</el-button>
        </el-tooltip>
        <el-tooltip content="‰∏âÁ∫ßÊ†áÈ¢ò" placement="bottom">
          <el-button @click.stop="$emit('insert-format', 'h3')" @mousedown.prevent type="default" tabindex="-1">H3</el-button>
        </el-tooltip>
      </el-button-group>

      <el-divider direction="vertical" />

      <!-- ÈìæÊé•ÂíåÂ™í‰Ωì -->
      <el-button-group size="small">
        <el-tooltip content="ÈìæÊé•" placement="bottom">
          <el-button @click.stop="$emit('insert-format', 'link')" @mousedown.prevent type="default" tabindex="-1">
            üîó
          </el-button>
        </el-tooltip>
        <el-tooltip content="ÂõæÁâá" placement="bottom">
          <el-button @click.stop="$emit('insert-format', 'image')" @mousedown.prevent type="default" tabindex="-1">
            üñºÔ∏è
          </el-button>
        </el-tooltip>
        <el-tooltip content="‰ª£Á†ÅÂùó" placement="bottom">
          <el-button @click.stop="$emit('insert-format', 'codeblock')" @mousedown.prevent type="default" tabindex="-1">
            {}
          </el-button>
        </el-tooltip>
      </el-button-group>

      <el-divider direction="vertical" />

      <!-- ÂàóË°®ÂíåÂºïÁî® -->
      <el-button-group size="small">
        <el-tooltip content="Êó†Â∫èÂàóË°®" placement="bottom">
          <el-button @click.stop="$emit('insert-format', 'unorderedlist')" @mousedown.prevent type="default" tabindex="-1">
            ‚Ä¢
          </el-button>
        </el-tooltip>
        <el-tooltip content="ÊúâÂ∫èÂàóË°®" placement="bottom">
          <el-button @click.stop="$emit('insert-format', 'orderedlist')" @mousedown.prevent type="default" tabindex="-1">
            1.
          </el-button>
        </el-tooltip>
        <el-tooltip content="ÂºïÁî®" placement="bottom">
          <el-button @click.stop="$emit('insert-format', 'blockquote')" @mousedown.prevent type="default" tabindex="-1">
            "
          </el-button>
        </el-tooltip>
      </el-button-group>

      <el-divider direction="vertical" />

      <!-- ÂÖ∂‰ªñÂÖÉÁ¥† -->
      <el-button-group size="small">
        <el-tooltip content="Ë°®ÊÉÖÁ¨¶Âè∑" placement="bottom">
          <el-button @click.stop="handleEmojiButtonClick" @mousedown.stop.prevent type="default" tabindex="-1">
            üòÄ
          </el-button>
        </el-tooltip>
        <el-tooltip content="Ë°®Ê†º" placement="bottom">
          <el-button @click.stop="$emit('insert-format', 'table')" @mousedown.prevent type="default" tabindex="-1">
            ‚äû
          </el-button>
        </el-tooltip>
        <el-tooltip content="Ê∞¥Âπ≥Á∫ø" placement="bottom">
          <el-button @click.stop="$emit('insert-format', 'hr')" @mousedown.prevent type="default" tabindex="-1">
            ‚Äï
          </el-button>
        </el-tooltip>
      </el-button-group>

      <!-- Ë°®ÊÉÖÁ¨¶Âè∑ÈÄâÊã©Èù¢Êùø -->
      <Teleport to="body">
        <div
          v-show="showEmojiPicker"
          class="emoji-picker-overlay"
          @click.stop="showEmojiPicker = false"
          @mousedown.stop.prevent
        >
          <div
            ref="emojiPicker"
            class="emoji-picker"
            :style="{ top: emojiPickerPosition.top + 'px', left: emojiPickerPosition.left + 'px' }"
            @click.stop
            @mousedown.stop.prevent
          >
            <div class="emoji-header">
              <span>ÈÄâÊã©Ë°®ÊÉÖÁ¨¶Âè∑</span>
              <el-button @click.stop="showEmojiPicker = false" type="text" size="small">‚úï</el-button>
            </div>
            <div class="emoji-grid">
              <button
                v-for="emoji in emojiList"
                :key="emoji"
                @click.stop="insertEmoji(emoji)"
                @mousedown.stop.prevent
                class="emoji-button"
                type="button"
              >
                {{ emoji }}
              </button>
            </div>
          </div>
        </div>
      </Teleport>
    </div>

    <!-- Âè≥‰æßÊìç‰Ωú -->
    <div class="toolbar-right">
      <!-- ‰∏ªÈ¢òÊåâÈíÆÁªÑ -->
      <el-button-group size="small">
        <el-tooltip content="ÊéíÁâà‰∏ªÈ¢ò" placement="bottom">
          <el-button @click.stop="toggleTypographyThemes" @mousedown.prevent type="default" tabindex="-1">
            <span class="theme-btn-icon">üìñ</span>
          </el-button>
        </el-tooltip>
        <el-tooltip content="‰ª£Á†Å‰∏ªÈ¢ò" placement="bottom">
          <el-button @click.stop="toggleCodeThemes" @mousedown.prevent type="default" tabindex="-1">
            <span class="theme-btn-icon">üíª</span>
          </el-button>
        </el-tooltip>
      </el-button-group>

      <el-divider direction="vertical" />

      <!-- Â∏ÉÂ±ÄÂàáÊç¢ÊåâÈíÆ -->
      <el-button-group size="small">
        <el-tooltip content="ÂàÜÊ†èËßÜÂõæ" placement="bottom">
          <el-button @click.stop="$emit('switch-layout', 'split')" @mousedown.prevent type="default" tabindex="-1">
            <el-icon><Grid /></el-icon>
          </el-button>
        </el-tooltip>
        <el-tooltip content="ÂÖ®Â±èÁºñËæë" placement="bottom">
          <el-button @click.stop="$emit('switch-layout', 'editor-fullscreen')" @mousedown.prevent type="default" tabindex="-1">
            <el-icon><Edit /></el-icon>
          </el-button>
        </el-tooltip>
        <el-tooltip content="ÂÖ®Â±èÈ¢ÑËßà" placement="bottom">
          <el-button @click.stop="$emit('switch-layout', 'preview-fullscreen')" @mousedown.prevent type="default" tabindex="-1">
            <el-icon><View /></el-icon>
          </el-button>
        </el-tooltip>
      </el-button-group>

      <el-divider direction="vertical" />

      <el-button @click.stop="$emit('toggle-preview')" @mousedown.prevent :type="showPreview ? 'primary' : 'default'" size="small" tabindex="-1">
        <el-icon><View /></el-icon>
        {{ showPreview ? 'ÈöêËóèÈ¢ÑËßà' : 'ÊòæÁ§∫È¢ÑËßà' }}
      </el-button>
      <el-button @click.stop="$emit('clear-content')" @mousedown.prevent type="danger" plain size="small" tabindex="-1">
        <el-icon><Delete /></el-icon>
        Ê∏ÖÁ©∫
      </el-button>
      <el-button @click.stop="$emit('export-markdown')" @mousedown.prevent type="success" size="small" tabindex="-1">
        <el-icon><Download /></el-icon>
        ÂØºÂá∫
      </el-button>
    </div>

    <!-- ÊéíÁâà‰∏ªÈ¢òÈù¢Êùø -->
    <Teleport to="body">
      <div
        v-show="showTypographyThemes"
        class="theme-panel-overlay"
        @click.stop="showTypographyThemes = false"
        @mousedown.stop.prevent
      >
        <div
          ref="typographyPanel"
          class="theme-panel typography-panel"
          :style="{ top: typographyPanelPosition.top + 'px', left: typographyPanelPosition.left + 'px' }"
          @click.stop
          @mousedown.stop.prevent
        >
          <div class="theme-panel-header">
            <span class="theme-panel-title">üìñ ÊéíÁâà‰∏ªÈ¢ò</span>
            <el-button @click.stop="showTypographyThemes = false" type="text" size="small">‚úï</el-button>
          </div>
          <div class="theme-grid">
            <div
              v-for="theme in typographyThemes"
              :key="theme.id"
              @click.stop="selectTypographyTheme(theme)"
              @mousedown.stop.prevent
              class="theme-item"
              :class="{ active: currentTypographyTheme === theme.id }"
            >
              <div class="theme-preview">
                <div class="preview-content" :class="`typography-${theme.id}`">
                  <h3>{{ theme.name }}</h3>
                  <p>{{ theme.description }}</p>
                  <p><em>Á§∫‰æãÊñáÊú¨Ôºö{{ theme.sample }}</em></p>
                </div>
              </div>
              <div class="theme-info">
                <div class="theme-name">{{ theme.name }}</div>
                <div class="theme-desc">{{ theme.description }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </Teleport>

    <!-- ‰ª£Á†Å‰∏ªÈ¢òÈù¢Êùø -->
    <Teleport to="body">
      <div
        v-show="showCodeThemes"
        class="theme-panel-overlay"
        @click.stop="showCodeThemes = false"
        @mousedown.stop.prevent
      >
        <div
          ref="codePanel"
          class="theme-panel code-panel"
          :style="{ top: codePanelPosition.top + 'px', left: codePanelPosition.left + 'px' }"
          @click.stop
          @mousedown.stop.prevent
        >
          <div class="theme-panel-header">
            <span class="theme-panel-title">üíª ‰ª£Á†Å‰∏ªÈ¢ò</span>
            <el-button @click.stop="showCodeThemes = false" type="text" size="small">‚úï</el-button>
          </div>
          <div class="theme-grid">
            <div
              v-for="theme in codeThemes"
              :key="theme.id"
              @click.stop="selectCodeTheme(theme)"
              @mousedown.stop.prevent
              class="theme-item"
              :class="{ active: currentCodeTheme === theme.id }"
            >
              <div class="theme-preview">
                <div class="preview-content" :class="`code-${theme.id}`">
                  <pre><code>{{ theme.sample }}</code></pre>
                </div>
              </div>
              <div class="theme-info">
                <div class="theme-name">{{ theme.name }}</div>
                <div class="theme-desc">{{ theme.description }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </Teleport>
  </div>
</template>

<script>
import { ArrowLeft, View, Delete, Download, Edit, Grid } from '@element-plus/icons-vue'
import { typographyThemes, codeThemes } from './themes.js'

export default {
  name: 'MarkdownEditorToolbar',
  components: {
    ArrowLeft,
    View,
    Delete,
    Download
  },
  props: {
    showPreview: {
      type: Boolean,
      default: true
    }
  },
  emits: ['back', 'insert-format', 'toggle-preview', 'clear-content', 'export-markdown', 'switch-layout', 'theme-change', 'typography-theme-change', 'code-theme-change'],
  data() {
    return {
      showEmojiPicker: false,
      emojiPickerPosition: { top: 0, left: 0 },
      currentTheme: 'default',
      // ‰∏ªÈ¢òÈù¢ÊùøÁä∂ÊÄÅ
      showTypographyThemes: false,
      showCodeThemes: false,
      typographyPanelPosition: { top: 0, left: 0 },
      codePanelPosition: { top: 0, left: 0 },
      currentTypographyTheme: 'classic',
      currentCodeTheme: 'github',
      // ‰ªéÂ§ñÈÉ®ÈÖçÁΩÆÊñá‰ª∂ÂØºÂÖ•‰∏ªÈ¢òÊï∞ÊçÆ
      typographyThemes: typographyThemes,
      codeThemes: codeThemes,
      emojiList: [
        'üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÜ', 'üòÖ', 'üòÇ', 'ü§£', 'üòä', 'üòá',
        'üôÇ', 'üôÉ', 'üòâ', 'üòå', 'üòç', 'ü•∞', 'üòò', 'üòó', 'üòô', 'üòö',
        'üòã', 'üòõ', 'üòù', 'üòú', 'ü§™', 'ü§®', 'üßê', 'ü§ì', 'üòé', 'ü§©',
        'ü•≥', 'üòè', 'üòí', 'üòû', 'üòî', 'üòü', 'üòï', 'üôÅ', '‚òπÔ∏è', 'üò£',
        'üòñ', 'üò´', 'üò©', 'ü•∫', 'üò¢', 'üò≠', 'üò§', 'üò†', 'üò°', 'ü§¨',
        'ü§Ø', 'üò≥', 'ü•µ', 'ü•∂', 'üò±', 'üò®', 'üò∞', 'üò•', 'üòì', 'ü§ó',
        'ü§≠', 'ü§´', 'ü§•', 'üò∂', 'üòê', 'üòë', 'üò¨', 'üôÑ', 'üòØ',
        'üò¶', 'üòß', 'üòÆ', 'üò≤', 'ü•±', 'üò¥', 'ü§§', 'üò™', 'üòµ', 'ü§ê',
        'ü•¥', 'ü§¢', 'ü§Æ', 'ü§ß', 'üò∑', 'ü§í', 'ü§ï', 'ü§ë', 'ü§†', 'üòà',
        'üëø', 'üëπ', 'üë∫', 'ü§°', 'üí©', 'üëª', 'üíÄ', '‚ò†Ô∏è', 'üëΩ', 'üëæ',
        'ü§ñ', 'üéÉ', 'üò∫', 'üò∏', 'üòπ', 'üòª', 'üòº', 'üòΩ', 'üôÄ', 'üòø',
        'üòæ', 'üëç', 'üëé', 'üëå', '‚úåÔ∏è', 'ü§û', 'ü§ü', 'ü§ò', 'ü§ô', 'üëà',
        'üëâ', 'üëÜ', 'üñï', 'üëá', '‚òùÔ∏è', 'üëã', 'ü§ö', 'üñêÔ∏è', '‚úã', 'üññ',
        'üëè', 'üôå', 'ü§≤', 'ü§ù', 'üôè', '‚úçÔ∏è', 'üíÖ', 'ü§≥', 'üí™', 'ü¶æ',
        'ü¶ø', 'ü¶µ', 'ü¶∂', 'üëÇ', 'ü¶ª', 'üëÉ', 'üß†', 'ü´Ä', 'ü´Å', 'ü¶∑',
        'ü¶¥', 'üëÄ', 'üëÅÔ∏è', 'üëÖ', 'üëÑ', 'üíã', 'ü©∏', '‚ù§Ô∏è', 'üß°', 'üíõ',
        'üíö', 'üíô', 'üíú', 'üñ§', 'ü§ç', 'ü§é', 'üíî', '‚ù§Ô∏è‚Äçüî•', '‚ù§Ô∏è‚Äçü©π', 'üíï',
        'üíû', 'üíì', 'üíó', 'üíñ', 'üíò', 'üíù', 'üíü', '‚òÆÔ∏è', '‚úùÔ∏è', '‚ò™Ô∏è',
        'üïâÔ∏è', '‚ò∏Ô∏è', '‚ú°Ô∏è', 'üîØ', 'üïé', '‚òØÔ∏è', '‚ò¶Ô∏è', 'üõê', '‚õé', '‚ôà',
        '‚ôâ', '‚ôä', '‚ôã', '‚ôå', '‚ôç', '‚ôé', '‚ôè', '‚ôê', '‚ôë', '‚ôí',
        '‚ôì', 'üÜî', '‚öõÔ∏è', 'üâë', '‚ò¢Ô∏è', '‚ò£Ô∏è', 'üì¥', 'üì≥', 'üà∂', 'üàö',
        'üà∏', 'üà∫', 'üà∑Ô∏è', '‚ú¥Ô∏è', '‚ùáÔ∏è', '‚Ñ¢Ô∏è', 'üéå', 'üî∞', 'üî±', '‚öúÔ∏è'
      ]
    }
  },
  mounted() {
    // ÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠Ë°®ÊÉÖÁ¨¶Âè∑Èù¢Êùø
    document.addEventListener('click', this.handleClickOutside)
    // ÁõëÂê¨Á™óÂè£Â§ßÂ∞èÂèòÂåñÔºåÈáçÊñ∞ËÆ°ÁÆóÈù¢Êùø‰ΩçÁΩÆ
    window.addEventListener('resize', this.recalculatePanelPositions)
    // ÁõëÂê¨ÊªöÂä®‰∫ã‰ª∂ÔºåÈáçÊñ∞ËÆ°ÁÆóÈù¢Êùø‰ΩçÁΩÆ
    window.addEventListener('scroll', this.recalculatePanelPositions)
  },
  beforeUnmount() {
    document.removeEventListener('click', this.handleClickOutside)
    window.removeEventListener('resize', this.recalculatePanelPositions)
    window.removeEventListener('scroll', this.recalculatePanelPositions)
  },
  methods: {
    handleEmojiButtonClick(event) {
      // Á°Æ‰øùÈòªÊ≠¢ÊâÄÊúâÂèØËÉΩÁöÑ‰∫ã‰ª∂‰º†Êí≠
      event.preventDefault()
      event.stopPropagation()
      event.stopImmediatePropagation()

      // ÂàáÊç¢Ë°®ÊÉÖÁ¨¶Âè∑Èù¢ÊùøÊòæÁ§∫Áä∂ÊÄÅ
      this.showEmojiPicker = !this.showEmojiPicker
    },
    toggleEmojiPicker() {
      this.showEmojiPicker = !this.showEmojiPicker
    },
    insertEmoji(emoji) {
      this.$emit('insert-format', 'emoji', emoji)
      this.showEmojiPicker = false
    },
    closeEmojiPicker() {
      this.showEmojiPicker = false
    },
    calculateEmojiPickerPosition() {
      // ËÆ°ÁÆóË°®ÊÉÖÁ¨¶Âè∑ÊåâÈíÆÁöÑ‰ΩçÁΩÆ
      const emojiButton = this.$el.querySelector('.toolbar-center .el-button-group:last-child .el-button')
      if (emojiButton) {
        const rect = emojiButton.getBoundingClientRect()
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop
        const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft

        // Â∞ÜÈù¢ÊùøÂÆö‰ΩçÂú®ÊåâÈíÆ‰∏ãÊñπÂ±Ö‰∏≠
        this.emojiPickerPosition = {
          top: rect.bottom + scrollTop + 5, // ÊåâÈíÆ‰∏ãÊñπ5px
          left: rect.left + scrollLeft + (rect.width / 2) - 176 // Â±Ö‰∏≠ÔºåÈù¢ÊùøÂÆΩÂ∫¶352pxÁöÑ‰∏ÄÂçä
        }
      }
    },
    handleClickOutside(event) {
      if (this.showEmojiPicker) {
        const emojiPicker = document.querySelector('.emoji-picker')
        const emojiButton = this.$el.querySelector('.toolbar-center .el-button-group:last-child .el-button')

        if (emojiPicker &&
            !emojiPicker.contains(event.target) &&
            emojiButton &&
            !emojiButton.contains(event.target)) {
          this.showEmojiPicker = false
        }
      }
    },
    handleThemeChange(theme) {
      this.currentTheme = theme
      this.$emit('theme-change', theme)
    },
    toggleTypographyThemes() {
      this.showTypographyThemes = !this.showTypographyThemes
      this.showCodeThemes = false
      this.showEmojiPicker = false
    },
    toggleCodeThemes() {
      this.showCodeThemes = !this.showCodeThemes
      this.showTypographyThemes = false
      this.showEmojiPicker = false
    },
    selectTypographyTheme(theme) {
      this.currentTypographyTheme = theme.id
      this.showTypographyThemes = false
      this.$emit('typography-theme-change', theme)
    },
    selectCodeTheme(theme) {
      this.currentCodeTheme = theme.id
      this.showCodeThemes = false
      this.$emit('code-theme-change', theme)
    },
    calculateTypographyPanelPosition() {
      // ËÆ°ÁÆóÊéíÁâà‰∏ªÈ¢òÊåâÈíÆÁöÑ‰ΩçÁΩÆ
      const typographyButton = this.$el.querySelector('.toolbar-right .el-button-group:first-child .el-button:first-child')
      if (typographyButton) {
        const rect = typographyButton.getBoundingClientRect()
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop
        const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft

        // Ëé∑ÂèñÈù¢ÊùøÁöÑÂÆûÈôÖÂ∞∫ÂØ∏
        const panelWidth = 400
        const panelHeight = 400

        // ËÆ°ÁÆóÊúÄ‰Ω≥‰ΩçÁΩÆ
        let top = rect.top + scrollTop - panelHeight - 10 // ÊåâÈíÆ‰∏äÊñπ10px
        let left = rect.left + scrollLeft + (rect.width / 2) - (panelWidth / 2) // Â±Ö‰∏≠

        // Á°Æ‰øùÈù¢Êùø‰∏ç‰ºöË∂ÖÂá∫ËßÜÁ™óËæπÁïå
        const viewportWidth = window.innerWidth
        const viewportHeight = window.innerHeight

        // Âè≥‰æßËæπÁïåÊ£ÄÊü•
        if (left + panelWidth > viewportWidth + scrollLeft) {
          left = viewportWidth + scrollLeft - panelWidth - 10
        }

        // Â∑¶‰æßËæπÁïåÊ£ÄÊü•
        if (left < scrollLeft + 10) {
          left = scrollLeft + 10
        }

        // ‰∏äÊñπÁ©∫Èó¥‰∏çË∂≥Êó∂ÔºåÊòæÁ§∫Âú®ÊåâÈíÆ‰∏ãÊñπ
        if (top < scrollTop + 10) {
          top = rect.bottom + scrollTop + 10
        }

        // ‰∏ãÊñπÁ©∫Èó¥‰∏çË∂≥Êó∂ÔºåÊòæÁ§∫Âú®ÊåâÈíÆ‰∏äÊñπ
        if (top + panelHeight > viewportHeight + scrollTop) {
          top = rect.top + scrollTop - panelHeight - 10
        }

        this.typographyPanelPosition = {
          top: Math.max(10, top),
          left: Math.max(10, left)
        }
      }
    },
    calculateCodePanelPosition() {
      // ËÆ°ÁÆó‰ª£Á†Å‰∏ªÈ¢òÊåâÈíÆÁöÑ‰ΩçÁΩÆ
      const codeButton = this.$el.querySelector('.toolbar-right .el-button-group:first-child .el-button:last-child')
      if (codeButton) {
        const rect = codeButton.getBoundingClientRect()
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop
        const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft

        // Ëé∑ÂèñÈù¢ÊùøÁöÑÂÆûÈôÖÂ∞∫ÂØ∏
        const panelWidth = 400
        const panelHeight = 400

        // ËÆ°ÁÆóÊúÄ‰Ω≥‰ΩçÁΩÆ
        let top = rect.top + scrollTop - panelHeight - 10 // ÊåâÈíÆ‰∏äÊñπ10px
        let left = rect.left + scrollLeft + (rect.width / 2) - (panelWidth / 2) // Â±Ö‰∏≠

        // Á°Æ‰øùÈù¢Êùø‰∏ç‰ºöË∂ÖÂá∫ËßÜÁ™óËæπÁïå
        const viewportWidth = window.innerWidth
        const viewportHeight = window.innerHeight

        // Âè≥‰æßËæπÁïåÊ£ÄÊü•
        if (left + panelWidth > viewportWidth + scrollLeft) {
          left = viewportWidth + scrollLeft - panelWidth - 10
        }

        // Â∑¶‰æßËæπÁïåÊ£ÄÊü•
        if (left < scrollLeft + 10) {
          left = scrollLeft + 10
        }

        // ‰∏äÊñπÁ©∫Èó¥‰∏çË∂≥Êó∂ÔºåÊòæÁ§∫Âú®ÊåâÈíÆ‰∏ãÊñπ
        if (top < scrollTop + 10) {
          top = rect.bottom + scrollTop + 10
        }

        // ‰∏ãÊñπÁ©∫Èó¥‰∏çË∂≥Êó∂ÔºåÊòæÁ§∫Âú®ÊåâÈíÆ‰∏äÊñπ
        if (top + panelHeight > viewportHeight + scrollTop) {
          top = rect.top + scrollTop - panelHeight - 10
        }

        this.codePanelPosition = {
          top: Math.max(10, top),
          left: Math.max(10, left)
        }
      }
    },
    // ÈáçÊñ∞ËÆ°ÁÆóÈù¢Êùø‰ΩçÁΩÆÁöÑÊñπÊ≥ï
    recalculatePanelPositions() {
      if (this.showTypographyThemes) {
        this.calculateTypographyPanelPosition()
      }
      if (this.showCodeThemes) {
        this.calculateCodePanelPosition()
      }
      if (this.showEmojiPicker) {
        this.calculateEmojiPickerPosition()
      }
    }
  },
  watch: {
    showEmojiPicker(newVal) {
      if (newVal) {
        // Âª∂ËøüËÆ°ÁÆó‰ΩçÁΩÆÔºåÁ°Æ‰øùDOMÂ∑≤Êõ¥Êñ∞
        this.$nextTick(() => {
          this.calculateEmojiPickerPosition()
        })
      }
    },
    showTypographyThemes(newVal) {
      if (newVal) {
        // Âª∂ËøüËÆ°ÁÆó‰ΩçÁΩÆÔºåÁ°Æ‰øùDOMÂ∑≤Êõ¥Êñ∞
        this.$nextTick(() => {
          this.calculateTypographyPanelPosition()
        })
      }
    },
    showCodeThemes(newVal) {
      if (newVal) {
        // Âª∂ËøüËÆ°ÁÆó‰ΩçÁΩÆÔºåÁ°Æ‰øùDOMÂ∑≤Êõ¥Êñ∞
        this.$nextTick(() => {
          this.calculateCodePanelPosition()
        })
      }
    }
  }
}
</script>

<style scoped>
.markdown-editor-toolbar {
  position: relative; /* Êîπ‰∏∫Áõ∏ÂØπÂÆö‰Ωç */
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 20px;
  background-color: #fff;
  border-bottom: 1px solid #e6e6e6;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  flex-shrink: 0; /* Èò≤Ê≠¢Â∑•ÂÖ∑Ê†èË¢´ÂéãÁº© */
  z-index: 1000; /* Á°Æ‰øùÂ∑•ÂÖ∑Ê†èÊú¨Ë∫´ÊúâË∂≥Â§üÈ´òÁöÑÂ±ÇÁ∫ß */
}

.toolbar-left {
  display: flex;
  align-items: center;
  gap: 12px;
  flex-shrink: 0;
}

.editor-title {
  font-size: 18px;
  font-weight: bold;
  color: #333;
}

.toolbar-center {
  display: flex;
  align-items: center;
  gap: 8px;
  overflow-x: auto;
  scrollbar-width: none;
  -ms-overflow-style: none;
  flex: 1;
  justify-content: center;
  margin: 0 20px;
}

.toolbar-center::-webkit-scrollbar {
  display: none;
}

.toolbar-right {
  display: flex;
  gap: 8px;
  flex-shrink: 0;
}

/* ÂìçÂ∫îÂºèËÆæËÆ° */
@media (max-width: 1024px) {
  .toolbar-center {
    margin: 0 10px;
  }

  .editor-title {
    font-size: 16px;
  }
}

@media (max-width: 768px) {
  .markdown-editor-toolbar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    padding: 8px 12px;
    flex-direction: column;
    gap: 8px;
    height: auto;
    min-height: 120px;
  }

  .toolbar-center {
    order: 3;
    width: 100%;
    margin: 0;
    justify-content: flex-start;
    overflow-x: auto;
    padding: 4px 0;
  }

  .toolbar-left {
    order: 1;
    width: 100%;
    justify-content: space-between;
  }

  .toolbar-right {
    order: 2;
    width: 100%;
    justify-content: center;
    flex-wrap: wrap;
  }

  .editor-title {
    display: none;
  }
}

@media (max-width: 480px) {
  .markdown-editor-toolbar {
    min-height: 140px;
  }

  .toolbar-center {
    gap: 4px;
  }

  .toolbar-right {
    gap: 4px;
  }

  /* Âú®Â∞èÂ±èÂπï‰∏äÈöêËóè‰∏Ä‰∫õ‰∏çÂ∏∏Áî®ÁöÑÊåâÈíÆÁªÑ */
  .toolbar-center > :nth-child(5),
  .toolbar-center > :nth-child(7) {
    display: none;
  }
}

/* Á°Æ‰øùÂ∑•ÂÖ∑Ê†èÂú®ÊâÄÊúâÊÉÖÂÜµ‰∏ãÈÉΩÂèØËßÅ */
.markdown-editor-toolbar {
  -webkit-transform: translateZ(0);
  transform: translateZ(0);
}

/* Èò≤Ê≠¢Â∑•ÂÖ∑Ê†èÂÜÖÂÆπÊ∫¢Âá∫ */
.toolbar-center {
  min-width: 0;
}

/* Â∑•ÂÖ∑Ê†èÈò¥ÂΩ±Â¢ûÂº∫ */
.markdown-editor-toolbar::after {
  content: '';
  position: absolute;
  bottom: -1px;
  left: 0;
  right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent, rgba(0,0,0,0.1), transparent);
}

/* ÊªöÂä®Êó∂ÁöÑËßÜËßâÂèçÈ¶à */
.markdown-editor-toolbar.scroll-shadow {
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

/* ÊØõÁéªÁíÉÊïàÊûúÂ¢ûÂº∫ */
.markdown-editor-toolbar {
  background-color: rgba(255, 255, 255, 0.95);
}

/* ÊîØÊåÅ Safari ÁöÑÊØõÁéªÁíÉÊïàÊûú */
@supports (backdrop-filter: blur(10px)) {
  .markdown-editor-toolbar {
    background-color: rgba(255, 255, 255, 0.8);
  }
}

/* Â∑•ÂÖ∑Ê†èÊåâÈíÆÊÇ¨ÂÅúÊïàÊûú */
.markdown-editor-toolbar :deep(.el-button:hover) {
  transform: translateY(-1px);
  transition: all 0.2s ease;
}

.markdown-editor-toolbar :deep(.el-button:active) {
  transform: translateY(0);
}

/* Â∑•ÂÖ∑ÊèêÁ§∫Ê†∑Âºè‰ºòÂåñ */
.markdown-editor-toolbar :deep(.el-tooltip__popper) {
  font-size: 12px;
  padding: 8px 12px;
}

/* Á°Æ‰øùÂ∑•ÂÖ∑Ê†èÂú®È´òÂàÜËæ®ÁéáÂ±èÂπï‰∏äÊ∏ÖÊô∞ */
@media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
  .markdown-editor-toolbar {
    border-bottom-width: 0.5px;
  }
}

/* Ë°®ÊÉÖÁ¨¶Âè∑ÈÄâÊã©Èù¢ÊùøÊ†∑Âºè */
.emoji-picker {
  position: absolute;
  top: 100%;
  left: 50%;
  transform: translateX(-50%);
  z-index: 10000;
  background-color: #fff;
  border: 1px solid #e6e6e6;
  border-radius: 8px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  width: 352px; /* Á≤æÁ°ÆËÆ°ÁÆóÔºö10*28 + 9*4 + 2*8 = 280 + 36 + 16 = 332pxÔºåÁïô8px‰ΩôÈáè */
  max-width: 352px;
  height: 320px; /* Â¢ûÂä†È´òÂ∫¶ÔºöÊòæÁ§∫Á∫¶9Ë°åË°®ÊÉÖÔºåÂ§¥ÈÉ®32px + ÁΩëÊ†º288px */
  max-height: 320px;
  overflow: hidden;
  animation: emojiFadeIn 0.2s ease-out;
}

.emoji-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 12px;
  background-color: #f8f9fa;
  border-bottom: 1px solid #e6e6e6;
  font-size: 12px;
  font-weight: bold;
  color: #333;
}

.emoji-grid {
  display: grid;
  grid-template-columns: repeat(10, 1fr);
  gap: 4px;
  padding: 8px;
  height: 272px; /* Èù¢ÊùøÊÄªÈ´ò320px - Â§¥ÈÉ®32px - ÂÜÖËæπË∑ù16px = 272px */
  max-height: 272px;
  overflow-y: auto;
  scrollbar-width: thin;
  scrollbar-color: #ccc transparent;
}

.emoji-grid::-webkit-scrollbar {
  width: 4px;
}

.emoji-grid::-webkit-scrollbar-track {
  background: transparent;
}

.emoji-grid::-webkit-scrollbar-thumb {
  background: #ccc;
  border-radius: 2px;
}

.emoji-grid::-webkit-scrollbar-thumb:hover {
  background: #999;
}

.emoji-button {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 28px;
  height: 28px;
  border: none;
  background: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 18px;
  transition: all 0.15s ease;
  user-select: none;
}

.emoji-button:hover {
  background-color: #f0f0f0;
  transform: scale(1.1);
}

.emoji-button:active {
  background-color: #e6e6e6;
  transform: scale(0.95);
}

/* Ë°®ÊÉÖÁ¨¶Âè∑Èù¢ÊùøÂä®Áîª */
@keyframes emojiFadeIn {
  from {
    opacity: 0;
    transform: translateX(-50%) translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }
}

/* ÂìçÂ∫îÂºèË°®ÊÉÖÁ¨¶Âè∑Èù¢Êùø */
@media (max-width: 768px) {
  .emoji-picker {
    max-width: 280px;
    max-height: 180px;
  }

  .emoji-grid {
    grid-template-columns: repeat(8, 1fr);
    gap: 2px;
    padding: 6px;
    max-height: 140px;
  }

  .emoji-button {
    width: 24px;
    height: 24px;
    font-size: 16px;
  }
}

@media (max-width: 480px) {
  .emoji-picker {
    max-width: 240px;
    max-height: 160px;
  }

  .emoji-grid {
    grid-template-columns: repeat(6, 1fr);
    gap: 2px;
    padding: 4px;
    max-height: 120px;
  }

  .emoji-button {
    width: 20px;
    height: 20px;
    font-size: 14px;
  }
}

/* ÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠Ë°®ÊÉÖÁ¨¶Âè∑Èù¢Êùø */
.emoji-picker::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: -1;
}

/* Ê∑±Ëâ≤Ê®°ÂºèÊîØÊåÅ */
@media (prefers-color-scheme: dark) {
  .markdown-editor-toolbar {
    background-color: rgba(24, 24, 24, 0.95);
    border-bottom-color: rgba(255, 255, 255, 0.1);
  }

  .editor-title {
    color: #e0e0e0;
  }

  .emoji-picker {
    background-color: rgba(24, 24, 24, 0.95);
    border-color: rgba(255, 255, 255, 0.1);
  }

  .emoji-header {
    background-color: rgba(32, 32, 32, 0.95);
    border-bottom-color: rgba(255, 255, 255, 0.1);
    color: #e0e0e0;
  }

  .emoji-button:hover {
    background-color: rgba(255, 255, 255, 0.1);
  }

  .emoji-button:active {
    background-color: rgba(255, 255, 255, 0.2);
  }
}

/* ‰∏ªÈ¢òÈÄâÊã©Âô®Ê†∑Âºè */
.theme-selector {
  display: flex;
  align-items: center;
}

.theme-selector :deep(.el-select) {
  min-width: 120px;
}

.theme-option {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 4px 0;
}

.theme-icon {
  font-size: 16px;
  width: 20px;
  text-align: center;
}

.theme-option span:last-child {
  font-size: 14px;
  color: #333;
}

/* ÂìçÂ∫îÂºè‰∏ªÈ¢òÈÄâÊã©Âô® */
@media (max-width: 768px) {
  .theme-selector {
    width: 100%;
    margin-bottom: 8px;
  }

  .theme-selector :deep(.el-select) {
    width: 100%;
    min-width: auto;
  }
}

@media (max-width: 480px) {
  .theme-selector :deep(.el-select) {
    font-size: 12px;
  }

  .theme-option {
    gap: 6px;
  }

  .theme-icon {
    font-size: 14px;
    width: 18px;
  }

  .theme-option span:last-child {
    font-size: 13px;
  }
}

/* ‰∏ªÈ¢òÈù¢ÊùøÊ†∑Âºè */
.theme-panel-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 10000;
  pointer-events: none;
}

.theme-panel-overlay .theme-panel {
  position: absolute;
  pointer-events: auto;
  z-index: 10001;
}

.theme-panel {
  background-color: #fff;
  border: 1px solid #e6e6e6;
  border-radius: 8px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  width: 400px;
  max-width: 90vw;
  max-height: 70vh;
  overflow: hidden;
  animation: themePanelFadeIn 0.2s ease-out;
}

.theme-panel-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 16px;
  background-color: #f8f9fa;
  border-bottom: 1px solid #e6e6e6;
  font-size: 14px;
  font-weight: bold;
  color: #333;
}

.theme-panel-title {
  display: flex;
  align-items: center;
  gap: 8px;
}

.theme-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 12px;
  padding: 16px;
  max-height: calc(70vh - 60px);
  overflow-y: auto;
  scrollbar-width: thin;
  scrollbar-color: #ccc transparent;
}

.theme-grid::-webkit-scrollbar {
  width: 4px;
}

.theme-grid::-webkit-scrollbar-track {
  background: transparent;
}

.theme-grid::-webkit-scrollbar-thumb {
  background: #ccc;
  border-radius: 2px;
}

.theme-grid::-webkit-scrollbar-thumb:hover {
  background: #999;
}

.theme-item {
  display: flex;
  flex-direction: column;
  border: 2px solid #e6e6e6;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s ease;
  overflow: hidden;
}

.theme-item:hover {
  border-color: #409eff;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(64, 158, 255, 0.15);
}

.theme-item.active {
  border-color: #67c23a;
  background-color: rgba(103, 194, 58, 0.05);
}

.theme-preview {
  padding: 12px;
  background-color: #fafafa;
  border-bottom: 1px solid #e6e6e6;
  min-height: 100px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.theme-preview .preview-content {
  width: 100%;
  font-size: 12px;
  line-height: 1.4;
  text-align: left;
}

.theme-preview .preview-content h3 {
  margin: 0 0 8px 0;
  font-size: 14px;
  font-weight: bold;
  color: #333;
}

.theme-preview .preview-content p {
  margin: 4px 0;
  color: #666;
}

.theme-preview .preview-content em {
  color: #999;
  font-style: italic;
}

.theme-preview .preview-content pre {
  margin: 8px 0;
  padding: 8px;
  background-color: #f6f8fa;
  border-radius: 4px;
  font-size: 11px;
  line-height: 1.3;
  overflow: hidden;
  white-space: pre-wrap;
  word-break: break-all;
}

.theme-preview .preview-content code {
  background-color: #f6f8fa;
  padding: 2px 4px;
  border-radius: 3px;
  font-size: 11px;
  color: #d73a49;
}

.theme-info {
  padding: 12px;
  background-color: #fff;
}

.theme-name {
  font-size: 14px;
  font-weight: bold;
  color: #333;
  margin-bottom: 4px;
}

.theme-desc {
  font-size: 12px;
  color: #666;
  line-height: 1.4;
}

/* ‰∏ªÈ¢òÈù¢ÊùøÂä®Áîª */
@keyframes themePanelFadeIn {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* ÂìçÂ∫îÂºè‰∏ªÈ¢òÈù¢Êùø */
@media (max-width: 768px) {
  .theme-panel {
    width: 350px;
    max-width: 95vw;
  }

  .theme-grid {
    grid-template-columns: 1fr;
    gap: 8px;
    padding: 12px;
  }

  .theme-item {
    flex-direction: row;
  }

  .theme-preview {
    flex: 1;
    min-height: auto;
    border-bottom: none;
    border-right: 1px solid #e6e6e6;
  }

  .theme-info {
    flex: 1;
  }
}

@media (max-width: 480px) {
  .theme-panel {
    width: 320px;
    max-width: 98vw;
  }

  .theme-grid {
    padding: 8px;
  }

  .theme-preview {
    padding: 8px;
  }

  .theme-info {
    padding: 8px;
  }

  .theme-name {
    font-size: 13px;
  }

  .theme-desc {
    font-size: 11px;
  }
}

/* Ê∑±Ëâ≤Ê®°ÂºèÊîØÊåÅ */
@media (prefers-color-scheme: dark) {
  .theme-panel {
    background-color: rgba(24, 24, 24, 0.95);
    border-color: rgba(255, 255, 255, 0.1);
  }

  .theme-panel-header {
    background-color: rgba(32, 32, 32, 0.95);
    border-bottom-color: rgba(255, 255, 255, 0.1);
    color: #e0e0e0;
  }

  .theme-item {
    border-color: rgba(255, 255, 255, 0.1);
  }

  .theme-item:hover {
    border-color: #409eff;
  }

  .theme-item.active {
    border-color: #67c23a;
    background-color: rgba(103, 194, 58, 0.1);
  }

  .theme-preview {
    background-color: rgba(32, 32, 32, 0.95);
    border-bottom-color: rgba(255, 255, 255, 0.1);
  }

  .theme-preview .preview-content h3 {
    color: #e0e0e0;
  }

  .theme-preview .preview-content p {
    color: #cccccc;
  }

  .theme-preview .preview-content em {
    color: #999;
  }

  .theme-preview .preview-content pre {
    background-color: rgba(32, 32, 32, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .theme-preview .preview-content code {
    background-color: rgba(32, 32, 32, 0.95);
    color: #ff7b72;
  }

  .theme-info {
    background-color: rgba(24, 24, 24, 0.95);
  }

  .theme-name {
    color: #e0e0e0;
  }

  .theme-desc {
    color: #cccccc;
  }
}

/* ‰∏ªÈ¢òÊåâÈíÆÂõæÊ†áÊ†∑Âºè */
.theme-btn-icon {
  font-size: 16px;
  line-height: 1;
}

/* ÂÖ®Â±ÄÊ†∑Âºè - Ë°®ÊÉÖÁ¨¶Âè∑Èù¢Êùø */
.emoji-picker-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 10000;
  pointer-events: none;
}

.emoji-picker-overlay .emoji-picker {
  position: absolute;
  pointer-events: auto;
  z-index: 10001;
}
</style>
